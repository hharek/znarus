tinymce.PluginManager.add("zn_explorer", function(editor, url) 
{
	/* Ссылка на объект window.Manager.open */
	var win;
	
	/*---------------------------- Кнопка Вставить изображение ----------------------------- */
	editor.addButton("zn_explorer_image", 
	{
		icon: "image",															/* Иконка image */
		stateSelector: "img:not([data-mce-object],[data-mce-placeholder])",		/* Выделять кнопку при выделении */
		onclick: function() 
		{
			/* Если выбран рисунок */
			var img = 
			{
				src: "",
				title: "",
				width: "",
				height: ""
			};
			
			var img_html = editor.selection.getNode();
			if (img_html.nodeName === "IMG")
			{
				if (editor.dom.getAttrib(img_html, "src") !== "") {	img.src = editor.dom.getAttrib(img_html, "src"); };
				if (editor.dom.getAttrib(img_html, "alt") !== "") {	img.title = editor.dom.getAttrib(img_html, "alt"); };
				if (editor.dom.getAttrib(img_html, "title") !== "") { img.title = editor.dom.getAttrib(img_html, "title"); };
				if (editor.dom.getAttrib(img_html, "width") !== "") { img.width = editor.dom.getAttrib(img_html, "width"); };
				if (editor.dom.getAttrib(img_html, "height") !== "") { img.height = editor.dom.getAttrib(img_html, "height"); };
			}
			
			/* Создаем окно */
			win = editor.windowManager.open
			({
				title: "Insert/edit image",
				body: 
				[
					/* Источник */
					{
						name: "src",
						type: "combobox",
						size: 40,
						autofocus: true,
						label: "Source",
						icon: "browse",
						value: img.src,
						onclick: function()
						{
							var window_url = "";
							
							/* Рисунок не указан */
							if (img.src === "" && editor.getParam("zn_explorer_image_url") !== undefined)
							{
								window_url = editor.getParam("zn_explorer_image_url");
							}
							/* Рисунок указан */
							else if (img.src !== "")
							{	
								window_url = img.src;
							}
							
							editor.windowManager.open
							({
								title: "Insert image",
								url: url + "/index.html#type=image&url=" + window_url,
								width: 800,
								height: 400
							});
						}
					},
					/* Заголовок */
					{
						name: "title",
						type: "textbox",
						label: "Title",
						value: img.title
					},
					/* Ширина и высота */
					{
						type: "container",
						label: "Dimensions",
						layout: "flex",
						align: "center",
						spacing: 5,
						items: 
						[
							{
								name: "width", 
								type: "textbox", 
								maxLength: 5, 
								size: 3, 
								ariaLabel: "Width",
								value: img.width
							},
							{
								type: "label", 
								text: "x"
							},
							{
								name: "height", 
								type: "textbox", 
								maxLength: 5, 
								size: 3, 
								ariaLabel: "Height",
								value: img.height
							}
						]
					}
				],
				onSubmit: zn_explorer_img_submit
			});
		}
	});
	
	/**
	 * Вставка изображения
	 */
	function zn_explorer_img_submit()
	{
		var data = {};
		data = tinymce.extend(data, win.toJSON());
		
		editor.selection.setContent(editor.dom.createHTML("img", 
		{
			src: data.src,
			alt: data.title,
			title: data.title,
			width: data.width,
			height: data.height
		}));
	}
	
	/*------------------------- Кнопка «Вставить ссылку на файл» -------------------------*/
	editor.addButton("zn_explorer_file", 
	{
		icon: "link",															/* Иконка link */
		stateSelector: "a[href]",												/* Выделять кнопку при выделении */
		onclick: function() 
		{
			/* Сведения по ссылке */
			var link = 
			{
				"txt" : "",
				"href" : "",
				"title" : "",
				"target" : ""
			};
			
			var link_html = editor.dom.getParent(editor.selection.getNode());
			if (link_html.nodeName === "A")
			{
				if (link_html.innerText !== undefined) { link.txt = link_html.innerText; }
				if (link_html.textContent !== undefined) { link.txt = link_html.textContent; }
				if (editor.dom.getAttrib(link_html, "href") !== "") { link.href = editor.dom.getAttrib(link_html, "href"); }
				if (editor.dom.getAttrib(link_html, "title") !== "") { link.title = editor.dom.getAttrib(link_html, "title"); }
				if (editor.dom.getAttrib(link_html, "target") !== "") { link.target = editor.dom.getAttrib(link_html, "target"); }
			}
			
			/* Создаем окно */
			win = editor.windowManager.open
			({
				title: "Insert link",
				body: 
				[
					/* Ссылка */
					{
						name: "href",
						type: "combobox",
						size: 40,
						autofocus: true,
						label: "Source",
						icon: "browse",
						value: link.href,
						onclick: function()
						{
							/* Ссылка не указана */
							var window_url = "";
							if (link.href === "")
							{
								window_url = editor.getParam("zn_explorer_file_url");
							}
							/* Ссылка указана */
							else
							{	
								window_url = link.href;
							}
							
							editor.windowManager.open
							({
								title: "Insert link",
								url: url + "/index.html#type=all&url=" + window_url,
								width: 800,
								height: 400
							});
						}
					},
					/* Текст */
					{
						name: "txt",
						type: "textbox",
						label: "Text to display",
						value: link.txt
					},
					/* Заголовок */
					{
						name: "title",
						type: "textbox",
						label: "Title",
						value: link.title
					},
					/* Открывать в новом окне */
					{
						name: "target",
						type: "listbox",
						label: "Target",
						value: link.target,
						values: 
						[
							{text: "None", value: ""},
							{text: "New window", value: "_blank"}
						]
					}
				],
				onSubmit: zn_explorer_link_submit
			});
		}
	});
	
	/**
	 * Вставка ссылки
	 */
	function zn_explorer_link_submit()
	{
		var data = {};
		data = tinymce.extend(data, win.toJSON());
		
		/* Данные по ссылке */
		var link =
		{
			href: data.href,
			target: data.target ? data.target : null,
			"class": data["class"] ? data["class"] : null,
			title: data.title ? data.title : null
		};
		
		/* Вставить новый */
		var link_html = editor.selection.getNode();
		if(link_html.nodeName !== "A")
		{
			editor.selection.setContent(editor.dom.createHTML("a", link, editor.dom.encode(data.txt)));
		}
		/* Изменить существующий */
		else
		{
			editor.execCommand("mceInsertLink", false, link);			
			if (link_html.innerText !== undefined)
			{
				link_html.innerText = data.txt;
			}
			else if (link_html.textContent !== undefined)
			{
				link_html.textContent = data.txt;
			}
		}
		
	}
});

